!function(e){"use strict";e([],function(){function e(e,t){"undefined"!=typeof t&&(t instanceof Error?(e._state.success=null,e._state.error=t):(t&&t._deep_undefined_&&(t=void 0),e._state.success=t,e._state.error=null)),e._running=!1,e._executing||e._next()}function t(e,t){e._running=!1,e._state.success=null,e._state.error=t,e._executing||e._next()}function n(n){n._executing=!0;for(var r=function(t){return e(n,t)},o=function(e){return t(n,e)};!n._running;){var i=n._state.queue.shift();if(n._state.error)for(;i&&"done"==i.type;)i=n._state.queue.shift();else for(;i&&"fail"==i.type;)i=n._state.queue.shift();if(!i)break;if(i.fn&&i.fn._deep_promise_){n._paused=!0,i.fn._context=n._context,i.fn.resolve();break}n._running=!0,n._state.oldQueue=n._state.queue,n._state.queue=[];var u=i.fn.call(n,n._state.success,n._state.error);if(u!==n){if(u&&"function"==typeof u.then){var c=u._deep_promise_||u._deep_chain_?u:s.when(u);c.done(r).fail(o)}else if(n._running=!1,"undefined"!=typeof u){var a;null!==u&&(u._deep_undefined_?(u=void 0,a=!1):a=u instanceof Error),n._state.success=a?null:u,n._state.error=a?u:null}n._state.oldQueue&&(n._state.queue.length?n._state.queue=n._state.queue.concat(n._state.oldQueue):n._state.queue=n._state.oldQueue,n._state.oldQueue=null)}else n._state.oldQueue&&(n._state.queue.length?n._state.queue=n._state.queue.concat(n._state.oldQueue):n._state.queue=n._state.oldQueue,n._state.oldQueue=null),n._running=!1}}function r(e){var t={};for(var n in e)t[n]=e[n];return t}var s={};s.Undefined={_deep_undefined_:!0},s.when=function(e){if(!e||!e.promise&&!e.then)return(new o).resolve(e);if(e._deep_deferred_)return e.promise();if("function"==typeof e.then){var t=new o;return e.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t}return"function"==typeof e.promise?e.promise():"object"==typeof e.promise?e.promise:(new o).resolve(e)},s.immediate=function(e){return(new o).resolve(e)},s.all=function(e){if(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),0===e.length)return s.immediate([]);var t=new o,n=e.length,r=0,i=-1,u=[];return e.every(function(e){if(t._rejected)return!1;var s=i+1;if(e&&e.then)e.then(function(e){u[s]=e,r++,r==n&&t.resolve(u)},function(e){t.ended()||t.reject(e)});else{if(e instanceof Error)return t.ended()||t.reject(e),!1;u[s]=e,r++,r==n&&t.resolve(u)}return i++,!0}),t},s.Deferred=function(){return this instanceof s.Deferred?(this._promises=[],this._deep_deferred_=!0,this):new s.Deferred},s.Deferred.prototype={_deep_deferred_:!0,_promises:null,rejected:!1,resolved:!1,canceled:!1,_success:null,_error:null,ended:function(){return this.rejected||this.resolved||this.canceled},resolve:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");if(e instanceof Error)return this.reject(e);this._success=e,this.resolved=!0;this._promises.forEach(function(t){t.resolve(e)})},reject:function(e){if(this.rejected||this.resolved)throw new Error("deferred has already been ended !");this._error=e,this.rejected=!0;this._promises.forEach(function(t){t.reject(e)})},promise:function(){var e=new o;return this.resolved?e.resolve(this._success):this.rejected?e.reject(this._error):(this._promises.push(e),e)}};var o=s.Promise=function(e,t){this._state=e=e||{},this._context=e.context||s.Promise.context,this._state.success=e.success||void 0,this._state.error=e.error||null,this._state.queue=e.queue||[],this._state.oldQueue=e.oldQueue||null,this._state.handlers=e.handlers||[],this._state.handlers.push(this),this._identity=s.Promise};return o.prototype={_locals:void 0,_deep_promise_:!0,_running:!1,_executing:!1,_initialised:!1,_resolved:!1,_rejected:!1,_enqueue:function(e,t){return this._state.queue.push({fn:e,type:t}),!this._initialised||this._running||this._executing||this._next(),this},_next:function(){if(this._initialised&&!this._paused){var e,t=this;if(0!==t._state.queue.length){try{e=s.Promise.context,e!==t._context&&(e&&e.suspend&&e.suspend(),s.Promise.context=t._context,t._context&&t._context.resume&&t._context.resume()),n(t)}catch(r){if(t._context.debug&&(o.dumpError?o.dumpError(r):console.error(r)),t._state.success=null,t._state.error=r,t._running=!1,t._context.rethrow)throw r}finally{e!==t._context&&(t._context&&t._context.suspend&&t._context.suspend(),e&&e.resume&&e.resume(),s.Promise.context=e)}t._executing=!1}}},ended:function(){return this._resolved||this._rejected},resolve:function(e){if(this.ended())throw new Error("promise already resolved or rejected");this._resolved=!0,this._paused=!1,this._initialised=!0,"undefined"!=typeof e&&(this._state.success=e);var t=this._state.success instanceof Error;return this._state.error=t?this._state.success:this._state.error,this._state.success=t?null:this._state.success,this._next(),this},reject:function(e){if(this.ended())throw new Error("promise already resolved or rejected");return this._rejected=!0,this._paused=!1,this._initialised=!0,this._state.error=e,this._next(),this},close:function(){return 1==this._state.handlers.length?this:(this._state.handlers.pop(),this._state.handlers[this._state.handlers.length-1])},clone:function(){return new this._identity({handlers:this._state.handlers.slice(),queue:this._state.queue?this._state.queue.slice():[],oldQueue:this._state.oldQueue?this._state.oldQueue.slice():null,success:this._state.success,error:this._state.error})},catchError:function(e){var t=this;return this.always(function(){t.toContext("rethrow",e?!0:!1)})},pushTo:function(e){var t=this;return t._initialised?this.always(function(){e.push(t)}):(e.push(t),this)},done:function(e){var t=this,n=function(n){if(!e)return n;var r=e.call(t,n);if(r!==t)return r};return t._enqueue(n,"done")},spread:function(e){var t=this,n=function(e){if(!callBack)return e;var n=callBack.apply(t,e&&e.forEach?e:[e]);if(n!==t)return n};return t._enqueue(n,"done")},fail:function(e){var t=this,n=function(n,r){if(!e)return r;var s=e.call(t,r);if(s!==t)return s};return t._enqueue(n,"fail")},always:function(e){var t=this,n=function(n,r){if(!e)return r||n;var s=e.call(t,n,r);if(s!==t)return s};return t._enqueue(n,"always")},then:function(e,t){var n=this;return e&&this.done(function(t){var r=e.call(n,t);if(r!==n)return r}),t&&this.fail(function(e){var r=t.call(n,e);if(r!==n)return r}),this},delay:function(e){return this.done(function(){var t=new o;return setTimeout(function(){t.resolve(void 0)},e),t})},toState:function(e,t){var n=this;return this.done(function(r){return e?(t="undefined"==typeof t?r:t,n._state[e]=t,t):new Error(".toState need key/val couple.")})},fromState:function(e){var t=this;return this.done(function(n){if(!e)return t._state;var r=t._state[e];return"undefined"==typeof r?deep.Undefined:r})},when:function(e){return this.done(function(){return e})},loop:function(e,t,n,r){return this.done(function(o){return s.loop(e,t,n,r||o)})}},s.promisify=function(e,t){return function(){var n=Array.prototype.slice.call(arguments),r=new o;return n.push(function(){var e=Array.prototype.slice.call(arguments),t=e.shift();t?r.reject(t):r.resolve(e.length<=1?e[1]:e)}),e.apply(t||{},n),r}},s.async=function(e,t,n){var r=new o,s=function(){var e=Array.prototype.slice.apply(arguments),t=e.shift();t?r.reject(t):r.resolve(e.length?1==e.length?e[0]:e:!0)};return n.push(s),e?"string"==typeof t?e[t].apply(e,n):t.apply(e,n):t.apply({},n),r},s.loop=function(e,t,n,r){var s=0,o=!1,i=function(r){return o?r:n&&(s++,s>n)?r:(this.done(e).delay(t).done(i),r)},u=(new prom.Promise).resolve(r).done(i);return u.finish=function(){o=!0},u},o.getLogger=function(){return o.context&&o.context.logger||o.logger||console},o.prototype.log=function(){var e=Array.prototype.slice.call(arguments);return this.elog.apply(this,e).slog.apply(this,e)},o.prototype.elog=function(){var e=Array.prototype.slice.call(arguments);return this.fail(function(t){var n=o.getLogger();e.push(t),n.error.apply(n,e)})},o.prototype.slog=function(){var e=Array.prototype.slice.call(arguments);return this.done(function(t){var n=o.getLogger();e.push(t),n.log.apply(n,e)})},o.context={rethrow:!1,debug:!0},o.contextualise=function(e){return e._context=o.context=o.context?r(o.context):{},e._contextualised=!0,o.context},s.contextualise=function(e){return(new o).resolve(void 0).contextualise(e)},s.delay=function(e){return(new o).resolve(void 0).delay(e)},o.prototype.toContext=function(e,t){var n=this;return this.done(function(r){if(!e)return new Error(".toContext need key/val couple or an object as first argument.");if("object"==typeof e){for(var s in e)n._context[s]=e[s];return r}return t="undefined"==typeof t?r:t,n._context[e]=t,r})},o.prototype.contextualise=function(e){var t=this;return this.done(function(n){if(t._context=o.contextualise(t),t._contextualised=!0,e)for(var r in e)t._context[r]=e[r];return n})},o.prototype.fromContext=function(e){var t=this;return this.done(function(){if(!e)return t._context;var n=t._context[e];return"undefined"==typeof n?s.Undefined:n})},o.prototype.clog=function(e){var t=this;return this.always(function(){e?o.getLogger().log("promise.context."+e+" : ",t._context[e]):o.getLogger().log("promise.context : ",t._context)})},o.prototype.debug=function(){var e=Array.prototype.slice.call(arguments);return this.always(function(t,n){if(o.context.debug){var r=o.getLogger();e.push(n||t),r.debug?r.debug.apply(r,e):r.log.apply(r,e)}})},s})}("undefined"!=typeof define?define:function(e,t){"undefined"!=typeof module?module.exports=t():promise=t()});